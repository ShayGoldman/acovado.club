services:
  proxy:
    image: traefik:v3.2.3
    container_name: proxy
    restart: unless-stopped
    # Instead of passing many --flags, we specify just one for our config file:
    command:
      - '--configFile=/etc/traefik/traefik.yaml'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yaml:/etc/traefik/traefik.yaml:ro
      - ./acme.json:/etc/traefik/acme.json
    ports:
      - '80:80'
      - '443:443'
    networks:
      - proxy-network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.proxy.rule=Host(`proxy.${DOMAIN}`)'
      - 'traefik.http.routers.proxy.entrypoints=websecure'
      - 'traefik.http.routers.proxy.tls.certresolver=acovado'
      - 'traefik.http.routers.proxy.service=api@internal'
      - 'traefik.http.routers.proxy.middlewares=auth'

  oauth2-proxy:
    image: bitnami/oauth2-proxy:latest
    container_name: oauth2-proxy
    restart: unless-stopped
    volumes:
      - ./authenticated_emails.txt:/etc/traefik/authenticated_emails.txt
    command: # Some things just don't work with environment variables
      - --authenticated-emails-file=/etc/traefik/authenticated_emails.txt
    environment:
      OAUTH2_PROXY_REVERSE_PROXY: true
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: true

      # Google OAuth
      OAUTH2_PROXY_PROVIDER: google
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}

      # Cookie Settings
      OAUTH2_PROXY_COOKIE_DOMAINS: .${DOMAIN} # use false only if no HTTPS in dev
      OAUTH2_PROXY_COOKIE_SECURE: true # use false only if no HTTPS in dev
      OAUTH2_PROXY_COOKIE_HTTPONLY: true
      OAUTH2_PROXY_COOKIE_EXPIRE: 168h # 7 days
      OAUTH2_PROXY_COOKIE_REFRESH: 1h

      # OAuth2 URLs (assuming subdomain auth.acovado.club)
      OAUTH2_PROXY_REDIRECT_URL: https://auth.${DOMAIN}/oauth2/callback
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_PROXY_PREFIX: /oauth2
      OAUTH2_PROXY_UPSTREAMS: static://200

    networks:
      - proxy-network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.oauth2-proxy.rule=Host(`auth.${DOMAIN}`)'
      - 'traefik.http.routers.oauth2-proxy.entrypoints=websecure'
      - 'traefik.http.routers.oauth2-proxy.tls.certresolver=acovado'
      - 'traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180'
      - 'traefik.http.middlewares.auth.forwardauth.address=http://oauth2-proxy:4180/'
      - 'traefik.http.middlewares.auth.forwardauth.trustForwardHeader=true'

  postgres:
    extends:
      file: infra/postgres/docker-compose.yaml
      service: postgres
    env_file:
      - ${ENV_FILES_ROOT}/postgres.env
    environment:
      POSTGRES_USER: production
      POSTGRES_PASSWORD: production
      POSTGRES_DB: production
    volumes:
      - ${VOLUMES_ROOT}/postgres-data:/var/lib/postgresql/data
    networks:
      - proxy-network

  # TODO Drizzle studio maybe?

  rabbitmq:
    extends:
      file: infra/rabbitmq/docker-compose.yaml
      service: rabbitmq
    env_file:
      - ${ENV_FILES_ROOT}/rabbitmq.env
    environment:
      RABBITMQ_DEFAULT_USER: rabbit
      RABBITMQ_DEFAULT_PASS: rabbit
    networks:
      - proxy-network

  grafana:
    extends:
      file: infra/tracing/docker-compose.yaml
      service: grafana
    env_file:
      - ${ENV_FILES_ROOT}/grafana.env
    volumes:
      - ${CONFIG_FILES_ROOT}/infra/tracing/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
    ports: []
    networks:
      - proxy-network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.grafana.rule=Host(`grafana.acovado.club`)'
      - 'traefik.http.routers.grafana.entrypoints=websecure'
      - 'traefik.http.routers.grafana.tls.certresolver=acovado'
      - 'traefik.http.services.grafana.loadbalancer.server.port=3000'
      - 'traefik.http.routers.grafana.middlewares=auth'
    depends_on:
      - jaeger
      - tempo
      - otel-collector

  otel-collector:
    extends:
      file: infra/tracing/docker-compose.yaml
      service: otel-collector
    env_file:
      - ${ENV_FILES_ROOT}/otel-collector.env
    volumes:
      - ${CONFIG_FILES_ROOT}/infra/tracing/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports: []
    networks:
      - proxy-network
    depends_on:
      - tempo

  jaeger:
    extends:
      file: infra/tracing/docker-compose.yaml
      service: jaeger
    env_file:
      - ${ENV_FILES_ROOT}/jaeger.env
    ports: []
    networks:
      - proxy-network
    depends_on:
      - tempo
      - otel-collector
    restart: unless-stopped
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.jaeger.rule=Host(`jaeger.acovado.club`)'
      - 'traefik.http.routers.jaeger.entrypoints=websecure'
      - 'traefik.http.routers.jaeger.tls.certresolver=acovado'
      - 'traefik.http.services.jaeger.loadbalancer.server.port=16686'
      - 'traefik.http.routers.jaeger.middlewares=auth'
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: '1gb'

  prometheus:
    extends:
      file: infra/tracing/docker-compose.yaml
      service: prometheus
    env_file:
      - ${ENV_FILES_ROOT}/prometheus.env
    volumes:
      - ${CONFIG_FILES_ROOT}/infra/tracing/prometheus.yaml:/etc/prometheus/prometheus.yml
    ports: []
    networks:
      - proxy-network

  tempo:
    extends:
      file: infra/tracing/docker-compose.yaml
      service: tempo
    env_file:
      - ${ENV_FILES_ROOT}/tempo.env
    ports: []
    command: [-config.file=/etc/tempo.yaml]
    volumes:
      - ${CONFIG_FILES_ROOT}/infra/tracing/tempo.yaml:/etc/tempo.yaml
      - ${VOLUMES_ROOT}/tempo-data:/tmp/tempo
    networks:
      - proxy-network

  stats:
    image: portainer/portainer-ce:2.25.1-alpine
    container_name: stats
    ports: []
    networks:
      - proxy-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/volumes/stats:/data
    restart: always
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.stats.rule=Host(`stats.acovado.club`)'
      - 'traefik.http.routers.stats.entrypoints=websecure'
      - 'traefik.http.routers.stats.tls.certresolver=acovado'
      - 'traefik.http.services.stats.loadbalancer.server.port=9000'
      - 'traefik.http.routers.stats.middlewares=auth'

networks:
  proxy-network:
    external: true
